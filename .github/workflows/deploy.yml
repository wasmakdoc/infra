

name: Provision and Deploy Web App
run-name: ${{ github.actor }} is deploying Calculate MicroserviceðŸš€
on:
  workflow_dispatch:

env:
  ARM_CLIENT_ID: "${{ secrets.DEVOPS_PRINCIPAL_CLIENT_ID }}"
  ARM_CLIENT_SECRET: "${{ secrets.DEVOPS_PRINCIPAL_CLIENT_SECRET }}"
  ARM_SUBSCRIPTION_ID:  "${{ vars.SUBSCRIPTION_ID }}"
  ARM_TENANT_ID: "${{ secrets.DEVOPS_PRINCIPAL_CLIENT_TENANT_ID }}"
  ARM_USE_AZUREAD: true

  


jobs:

  Deploy-Terraform-And-App:
    runs-on: ubuntu-latest
    environment: 
      name: Dev
    steps:
      - run : echo "${{ vars.ENVIRONMENT_NAME}}"

      - name: Checkout code
        uses: actions/checkout@v2      

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
  
      - name: Terraform Init
        working-directory: ./terraform
        id: init
        run: terraform init -backend-config="key=${{ vars.ENVIRONMENT_NAME}}.tfstate" -backend-config="resource_group_name=${{secrets.BACKEND_AZURE_RESOURCE_GROUP_NAME}}" -backend-config="storage_account_name=${{secrets.BACKEND_AZURE_STORAGE_ACCOUNT_NAME}}" -backend-config="container_name=${{secrets.BACKEND_AZURE_STORAGE_ACCOUNT_CONTAINER_NAME}}"

      - name: Terraform Apply
        working-directory: ./terraform
        id: apply
        run: terraform apply --var-file="env/${{vars.ENVIRONMENT_NAME}}.tfvars" --auto-approve

      - name: Terraform Output
        shell: bash
        working-directory: ./terraform
        id: tfoutput
        run:  |
          echo "AZURE_WEBAPP_NAME=$(terraform output -raw app_service_name)" >> "$GITHUB_OUTPUT"          
        
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Setup .NET Core SDK
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ' 8.0.x'  
      
      # Run dotnet build and publish
      - name: dotnet build and publish
        working-directory: ./application  
        run: |
          dotnet restore
          dotnet build --configuration Release
          dotnet publish -c Release --property:PublishDir='${{ runner.temp }}/myapp'  

      # Deploy to Azure Web apps
      - name: 'Run Azure webapp deploy action using publish profile credentials'      
        uses: azure/webapps-deploy@v3
        with: 
          app-name: ${{ steps.tfoutput.AZURE_WEBAPP_NAME }} # Replace with your app name
          package: '${{ runner.temp }}/myapp'
          startup-command: "./AjgPlatformTest"

      - name: logout
        run: |
          az logout





