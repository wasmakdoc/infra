

name: Validate Deployment
run-name: ${{ github.actor }} is validating Calculate Microservice DeploymentðŸš€
on:
  workflow_dispatch:




jobs:

  Deploy-tf-dotnet:
    runs-on: ubuntu-latest
    environment: 
      name: Ajg
    env:
      ARM_USE_AZUREAD: true
      AZURE_WEBAPP_NAME:  ""
      ARM_SUBSCRIPTION_ID:  "${{ vars.SUBSCRIPTION_ID }}"          

    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Checkout code
        uses: actions/checkout@v2      

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with: 
          terraform_wrapper: false
  
      - name: Terraform Init
        working-directory: ./terraform
        id: init
        run: terraform init -backend-config="key=terraform.tfstate" -backend-config="resource_group_name=${{ vars.BACKEND_AZURE_RESOURCE_GROUP_NAME }}" -backend-config="storage_account_name=${{vars.BACKEND_AZURE_STORAGE_ACCOUNT_NAME}}" -backend-config="container_name=${{vars.BACKEND_AZURE_STORAGE_ACCOUNT_CONTAINER_NAME}}"

      - name: Terraform Apply
        working-directory: ./terraform
        id: apply
        run: |
         terraform apply --var-file="env/${{vars.ENVIRONMENT_NAME}}.tfvars" --auto-approve    
         echo "AZURE_WEBAPP_NAME=$(terraform output -raw app_service_name)" >> $GITHUB_ENV
         echo ${{ env.AZURE_WEBAPP_NAME }}

      - name: Validate Deployment
        shell: pwsh
        run: |
          ls
          .\validate.tests.ps1 -TerraformConfigurationPath "terraform"      

      - name: logout
        run: |
          az logout


   

    
